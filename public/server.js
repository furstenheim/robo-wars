(function(){'use strict';function a(n){return JSON.parse(JSON.stringify(n))}function b(n,o){return Array.isArray(n)?b(n[0],n[1]):{x:n,y:o}}var f={},l=['ArrowRight','ArrowUp','ArrowLeft','ArrowDown'],m=Math.PI/2;f.Actions={init:function(){return{players:[]}},types:{player:'player',laser:'laser',death:'death',win:'win'}},b.add=function(n,o){return new b(n.x+o.x,n.y+o.y)},b.multiply=function(n,o){return new b(n.x*o.x-n.y*o.y,n.x*o.y+n.y*o.x)},b.getTheta=function(n){return 0===n.x?1===n.y?1*m:3*m:1===n.x?0:2*m},f.Game={get sx(){return 20},get sy(){return 15},init:function(){return{h:40*f.Game.sy,w:40*f.Game.sx,sx:f.Game.sx,sy:f.Game.sy,np:f.Game.np}},get np(){return 4},prepareGame:function(n,o){var p,q,s,r=['floor','wall'],t=[],u=[],v=[0,0.05,0.99,0.5],z=[0.5,0.55,0.5,0.99],A=[[1,0],[0,1],[-1,0],[0,-1]],B=[],C=[];for(p=0;p<o;p++){let D=~~(v[p]*n.sx),E=~~(z[p]*n.sy);B.push(D),C.push(E),u.push(f.Player.init(b(D,E),'player'+p,b(A[p]),1,f.Player.statuses.alive))}for(p=0;p<n.sx;p++)for(q=0;q<n.sy;q++){s=r[0.85>Math.random()?0:1];for(let D=0;D<B.length;D++)2.5>Math.abs(p-B[D])+Math.abs(q-C[D])&&(s=r[0]);t.push(f.Tile.init(p,q,s))}return{game:n,players:u,tiles:t,remainingActions:[],postActions:[]}},computeMovements(n,o){var s,p=a(n),q=[],r=p.players;for(let t of o){let u=t.position;if(r[u].s!==f.Player.statuses.dead){let J=f.Player.handleAction(r[u],t),K={player:J.player,position:u},L=[K],M=J.direction;if(M){for(;K=f.Game.computePlayerCollision(K.player,r,M);)L.push(K);f.Game.computeMovementObstruction(L[L.length-1].player,p)&&(L=[{player:r[u],position:u}])}for(let Q of L)r[Q.position]=Q.player;let N=[],O=r[u];if(s=f.Game.computeLasers(O,r,p)){let Q=f.Player.decreaseHealth(s.oplayer),R=r[s.oposition].s===f.Player.statuses.alive&&Q.s===f.Player.statuses.dead;if(r[s.oposition]=Q,N.push(Object.assign(s,{oplayer:Q})),R){N.push({type:f.Actions.types.death,oposition:s.oposition});let S=0,T=-1;for(let U=0;U<r.length;U++)r[U].s===f.Player.statuses.dead?S++:T=U;(S=r.length-1)&&N.push({type:f.Actions.types.win,position:T})}}q.push({movements:L,postActions:N})}}return{state:p,actions:q}},computePlayerCollision(n,o,p){for(let q=0;q<o.length;q++)if(f.Player.collide(n,o[q]))return{position:q,player:f.Player.move(o[q],p)}},computeMovementObstruction(n,o){var p=n.c,q=o.game;return 0>p.x||0>p.y||p.x>=q.sx||p.y>=q.sy||!('wall'!==o.tiles[q.sy*p.x+p.y].type)||void 0},computeLasers(n,o,p){var q=n;for(let r=0;4>r;r++){if(q=f.Player.handleAction(q,{subtype:'ArrowUp'}).player,f.Game.computeMovementObstruction(q,p))return!1;for(let s=0;s<o.length;s++)if(f.Player.collide(q,o[s]))return{type:'laser',player:n,oplayer:o[s],oposition:s}}}},f.Player={init:function(n,o,p,q,r){var s=f.PlayerTile.init(n.x,n.y,o,b.getTheta(p));return{t:s,o:p,c:n,type:o,h:q,s:r}},handleAction(n,o){var p=o.subtype;return'ArrowUp'===p?{player:f.Player.move(n,n.o),direction:n.o}:'ArrowLeft'===p?{player:f.Player.init(n.c,n.type,b.multiply(n.o,{x:0,y:-1}),n.h,n.s)}:'ArrowRight'===p?{player:f.Player.init(n.c,n.type,b.multiply(n.o,{x:0,y:1}),n.h,n.s)}:'ArrowDown'===p?{player:f.Player.move(n,b.multiply({x:-1,y:0},n.o)),direction:b.multiply({x:-1,y:0},n.o)}:void 0},move(n,o){return f.Player.init(b.add(n.c,o),n.type,n.o,n.h,n.s)},collide(n,o){return n.c.x===o.c.x&&n.c.y===o.c.y},decreaseHealth(n){var o=0.93*n.h;return f.Player.init(n.c,n.type,n.o,o,0.5>o?f.Player.statuses.dead:f.Player.statuses.alive)},statuses:{dead:'dead',alive:'alive'}},f.PlayerTile={init:function(n,o,p,q){return{x:n,y:o,type:p,t:q}},changeState:function(n,o,p,q){return{x:n.x+o,y:n.y+p,type:n.type,t:n.t+q}}},f.store={},f.Tile={init:function(n,o,p){return{x:n,y:o,type:p}},render:function(n,o,p){if(p&&!o){var q=f.Game.getRealCoordinates(n,p.x,p.y),r=f.bgc,s=new Image;s.src=f.Tiles[p.type],r.drawImage(s,q.x,q.y,q.w,q.h)}}},'undefined'!=typeof window&&function(){function n(){o.on('actions',function(q){f.store.acceptActions(q)}),o.on('start',function(q){f.store.startGame(JSON.parse(q))}),o.on('end',function(){}),o.on('connect',function(){}),o.on('disconnect',function(){}),o.on('winner',function(q){f.store.handleWin(q,f.store.state)}),o.on('error',function(){})}var o,p=document.getElementById.bind(document);for(let q in Object.assign(f.Game,{getRealCoordinates:function(q,r,s){return{x:r*q.w/q.sx,y:s*q.h/q.sy,w:q.w/q.sx,h:q.h/q.sy}}}),f.Input={init:function(){return{time:new Date,actions:[]}},size:{w:800,h:40},max:4,renderRobot:function(q){var r=f.Input.size.h,s=f.Input.size.w,t=f.ic,u=q.position,v=f.images['player'+u];t.clearRect(0,r,s,s),t.drawImage(v,0,r,r*f.Input.max,r*f.Input.max)},render:function(q,r){var s=f.Input.size.h,t=f.Input.size.w,u=f.ic,v=~~(s/30),z=s*f.Input.max+s/2,A=s/2;u.beginPath(),u.clearRect(0,0,t,s);for(let B=0;B<f.Input.max;B++){u.strokeStyle='black',u.strokeRect(s*B+v,v,s-2*v,s-2*v);let C=q.actions[B];if(C){u.save();let D=f.images.arrow;u.translate(s*B+s/2,s/2),u.rotate(-f.Input.subtypeToTheta(C.subtype)),u.drawImage(D,-(s-2*v)/2,-(s-2*v)/2,s-2*v,s-2*v),u.restore()}}r=Math.max(Math.min(r,1),0),0<r&&(u.beginPath(),u.fillStyle='red',u.moveTo(z,A),u.arc(z,A,A-2*v,0,4*r*m),u.lineTo(z,A),u.closePath(),u.fill()),u.stroke()},clear:function(){var q=f.Input.size.h,r=f.Input.size.w,s=f.ic;s.clearRect(0,0,r,q)},subtypeToTheta(q){var r=l.indexOf(q);if(-1<r)return m*r},acceptAction(q,r,s,t){var u=Math.random()<s,v=a(q);return q.actions.length>=f.Input.max?q:(u?v.actions.push({type:f.Actions.types.player,subtype:r,remainingTime:t}):v.actions.push({type:f.Actions.types.player,subtype:l[~~(4*Math.random())],remainingTime:t}),v)},fillInput(q){var s,r=a(q);for(s=q.actions.length;s<f.Input.max;s++)r.actions.push({type:f.Actions.types.player,subtype:l[~~(4*Math.random())],remainingTime:0});return r}},f.Laser={render(q,r,s,t){t=Math.min(Math.max(t,0),f.store.laserMovement)/f.store.laserMovement;var u=f.Game.getRealCoordinates(q,r.c.x,r.c.y),v=f.Game.getRealCoordinates(q,s.c.x,s.c.y),z=f.lc;z.clearRect(0,0,q.w,q.h),z.strokeStyle='red',z.beginPath();var A=u.x+q.w/q.sx/2,B=u.y+q.h/q.sy/2,C=v.x+q.w/q.sx/2,D=v.y+q.h/q.sy/2;z.moveTo(A,B),z.lineTo(C,D),z.stroke()},showLaser(q,r,s){var t=f.Laser.animating,u=new Date-f.Laser.time;if(t){if(u>f.store.laserMovement){f.Laser.animating=!1;var v=f.lc;v.clearRect(0,0,q.w,q.h)}else window.requestAnimationFrame(()=>f.Laser.showLaser(q,r,s)),f.Laser.render(q,r,s,u);return}f.Laser.time=new Date,f.Laser.animating=!0,window.requestAnimationFrame(()=>f.Laser.showLaser(q,r,s))}},Object.assign(f.PlayerTile,{render:function(q,r,s,t){if(s){var v,z,A,B,u=f.Game.getRealCoordinates(q,s.x,s.y);if(t=Math.min(Math.max(t,0),f.store.movement)/f.store.movement,!r)v=u.x,z=u.y,A=s.t;else{var C=f.Game.getRealCoordinates(q,r.x,r.y);v=(1-t)*C.x+t*u.x,z=(1-t)*C.y+t*u.y,B=Math.abs(r.t-s.t)<2*m?r.t:Math.abs(r.t-4*m-s.t)<Math.abs(r.t+4*m-s.t)?r.t-4*m:r.t+4*m,A=(1-t)*B+t*s.t}var D=f.c;f.c.save();var E=u.w/2,F=u.h/2;f.c.translate(v+E,z+F),f.c.rotate(A);var G=f.images[s.type];D.drawImage(G,-F,-E,2*E,2*F),f.c.restore()}}}),f.store={init:function(){return{game:f.Game.init(),tiles:[],players:[],remainingActions:[],postActions:[]}},movement:1000,laserMovement:50,inputActions:4,inputTime:2000,listenInput:!1,get tick(){return this.movement/60},startGame(q){var r=f.store.state;f.store.oldState=r,f.store.state=q,f.store.render(r,q),f.Input.renderRobot(q),f.store.renderHealth(q.players),f.message.textContent=null,f.store.acceptInput()},acceptInput(){if(!f.store.input&&!f.store.dead&&!f.won)return f.store.input=f.Input.init(),document.addEventListener('keydown',f.store.handleKeyDown,!1),window.requestAnimationFrame(f.store.acceptInput);var q=(f.store.inputTime-(new Date-new Date(f.store.input.time)))/f.store.inputTime;return 0>q?(document.removeEventListener('keydown',f.store.handleKeyDown),f.store.input=f.Input.fillInput(f.store.input),f.Input.render(f.store.input,-1),f.store.sendMovements(f.store.input.actions),void(f.store.input=!1)):void(f.Input.render(f.store.input,q),window.requestAnimationFrame(f.store.acceptInput))},acceptActions(q){var r=f.store.state,s=a(r);s.remainingActions=q,f.store.oldState=r,f.store.state=s,f.store.displayMovement()},prepareGame(){var q=f.store.state,r=a(q),s=q.game,t=f.Game.prepareGame(s);r.tiles=t.tiles,r.players=t.players,f.store.state=r,f.store.oldState=q,f.store.render(q,r)},sendMovements(q){o.emit('move',q)},render(q,r,s){f.c.clearRect(0,0,r.game.w,r.game.h);var z,t=q.tiles,u=r.tiles,v=r.game;for(z=0;z<Math.max(t.length,u.length);z++)f.Tile.render(v,t[z],u[z]);var A=q.players,B=r.players;for(z=0;z<Math.max(A.length,B.length);z++)f.PlayerTile.render(v,(A[z]||{}).t,(B[z]||{}).t,s)},displayMovement(){var q=f.store.oldState,r=f.store.state,s=r.game,t=f.store.animating,u=new Date-f.store.time;if(t)return u>f.store.movement&&(f.store.animating=!1),window.requestAnimationFrame(f.store.displayMovement),f.store.render(q,r,u);var B,v=a(r),z=v.remainingActions,A=v.postActions;if(A.length){for(let C of A)f.store.handleAction(v,C);v.postActions=[]}else{if(!z.length)return void f.store.acceptInput();B=z.shift();for(let C of B.movements)Object.assign(v.players[C.position],C.player);v.postActions=B.postActions}f.store.oldState=r,f.store.state=v,f.store.animating=!0,f.store.time=new Date,window.requestAnimationFrame(f.store.displayMovement)},handleAction(q,r){return r.type===f.Actions.types.laser?(Object.assign(q.players[r.oposition],r.oplayer),f.store.renderHealth(q.players),void f.Laser.showLaser(q.game,r.player,r.oplayer)):r.type===f.Actions.types.death?void f.store.handleDeath(r.oposition,q):void(r.type===f.Actions.types.win&&f.store.handleWin(r.position,q))},handleKeyDown(q){var r=q.key||q.code,s=f.store.input,t=a(s),u=(f.store.inputTime-(new Date-new Date(f.store.input.time)))/f.store.inputTime;-1!==l.indexOf(r)&&(f.store.input=f.Input.acceptAction(s,r,1,u))},renderHealth(q){var s,r=[];for(let t=0;t<q.length;t++)s=q[t],r.push(`Player ${t} health: ${parseInt(100*(2*(Math.max(s.h,0.5)-0.5)))} %`);f.health.textContent=r.join(' ')},handleDeath(q,r){q===r.position&&(f.store.dead=!0,f.message.textContent='You are dead')},handleWin(q,r){q===r.position&&(f.won=!0,f.message.textContent='You WON')}},Object.assign(f.Tile,{render:function(q,r,s){if(s&&!r){var t=f.Game.getRealCoordinates(q,s.x,s.y),u=f.bgc,v=f.images[s.type];u.drawImage(v,t.x,t.y,t.w,t.h)}}}),f.Tiles={},f.Tiles={floor:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAIAAADZF8uwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLCTo0C01FEQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABQSURBVBjTpVBBDgAgCCr/Wr0pe0r1tw6txhJPcVNAHHGOHg6a1pRLMIgo8iAe0bS+IlxtYK7YlTWQOGsQ7w80COXI4/c+Lem7J8zlPeGYclkeyCQcEkGchAAAAABJRU5ErkJggg==',wall:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAIAAADZF8uwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLChMusC+d2QAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABLSURBVBjTY7S1tWUgBJjQ+GqqqjgVweVu3b6NqY2RHOvQDIYwmLA6BW4phMEEUQEXRTMDYRKyY9HMQHcTXCtmKBDtO2TrsRpGlEkAsuEcUVru56YAAAAASUVORK5CYII=',player0:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wAAAAAzJ3zzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLCykj6vVVKgAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAACrSURBVEjHY8yOD2WgJWBioDEY+hawwBhTF67+T6lh2fGhjMMviBjRk+mNj1v+MzAwMGio/GS4cYcdqyZkOQ1+H0ayfIBuuIbKT5xyZFmAbCA+35BtAbKB5BqOkkzx+QTZAhh/74bvDAwMDAx7GRDJm6xkiu56Un3DQqzL0YFzACflqQgW0RoqP1EinWoZDeaDG3fYMeKBpjmZlHiguLCjOBUNvcJutMqkuwUAklJFrPsWPH0AAAAASUVORK5CYII=',player1:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QAawBfAFVrQDHVAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLCyYCIQRZuwAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAACwSURBVEjHY7S3tWGgJWBioDFgQWL/x6OOEYsYUerp6gOCQEdJEs6+cu85yRYwMjAwMHz69PE/ruA4duEjToP4+PgZCfrg06ePZAfFp08fGawMNDB8yEKqQciG4Il0+kUyVS2YsnA1w5SFqwcuo1EMcuJDR4OIuCBCzuWDzwfHLtzAlQEZaRpExy7cYODj4x/gCgebC6AFGSOW0vM/MWURUUGEy+JBVyczkqiXcVD4AAAU0DA4nLYhlQAAAABJRU5ErkJggg==',player2:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLEQITq+2+SQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAC8SURBVEjHzVXJEYAwCBTGEtOEFdlEOrMI/KiTY0nAm5l8EtjlCpCIDE/KaFUkosMTESGzXSuCFFSTHhkksABbifgO8JZdFoGmFGOs7kIIpki45xkCb92rKULe90DQe4nDXs9VvXk7Wg1S5hIc5bvSWTadKa/DeKVzMpnyNO0kPDws9xEoNWDvbPH+alhkTxehJkgJ2Gp0Vo9bw6pnjN7do0IjsUZYjesrfwJlgb0LxLsPvtlor+3kf40KRVYGyn7QjXEhqwAAAABJRU5ErkJggg==',player3:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLEC0oCTgFNwAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAADnSURBVEjH7ZUxEoIwEEX/RsYTeAUbr2KjlZWdx7KjogIKOQpNruAFLGQtIBgQFmLI2LgzzBaQ/2aX3R9iZoQMhcARHBD5HCaitr/MTN4AW7AX69Ez0k8+HvajL7O8UACqqQo+AJLoACQCQABWzPyYBLiIm0izG4ltNQBbPL1f39DNxQsyOKZGdEg8iXWdS90+UuXOe3A6b+u86+ZJgF2maZHdqkUXTep7Euu2CiermDtBRjwpdSfPXrSlR9Xb7LK8ICIKA2jsQrHgN8p1M3vfVQCeggnKZjfXTceMzhnwzX1A/zv554AXJGZ3EDgQafoAAAAASUVORK5CYII=',arrow:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkLCiA4sJBNuAAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABXSURBVDjLxZNBDoBACAPb/f+fZw+6hsNqBBLl3iGlxYA6M9ScdwAb2dQB4AtUtnADqd0gQIxUjwHcA3wX46OFTBNjAmcqo7o5b2FtD+JclTfiowd/f+METjMlD4iLdKcAAAAASUVORK5CYII='},f.canvas=document.getElementById('c'),f.c=f.canvas.getContext('2d'),f.bgcanvas=document.getElementById('bgc'),f.bgc=f.bgcanvas.getContext('2d'),f.icanvas=document.getElementById('ic'),f.ic=f.icanvas.getContext('2d'),f.lcanvas=document.getElementById('lc'),f.lc=f.lcanvas.getContext('2d'),f.health=p('health'),f.message=p('message'),f.images={},f.Tiles){let r=new Image;r.src=f.Tiles[q],f.images[q]=r}window.addEventListener('load',function(){o=io({upgrade:!1,transports:['websocket']}),n()},!1),f.store.state=f.store.init()}(),'undefined'==typeof window&&function(){function n(s){for(let t of r)if(s!==t&&t.opponents.length<f.Game.np-1&&!t.started){for(let u of t.opponents)s.opponents.push(u),u.opponents.push(s),u.removeCount();t.opponents.push(s),s.opponents.push(t),t.opponents.length===f.Game.np-1?new p([t].concat(t.opponents)).start():t.startCount()}}function o(s){s.game&&s.game.removeUser(s),r.splice(r.indexOf(s),1)}function p(s){this.users=s}function q(s){this.socket=s,this.game=null,this.alive=!0,this.opponents=[]}var r=[];p.prototype.start=function(){var s=f.Game.init(),t=this.users;this.state=f.Game.prepareGame(s,this.users.length),this.alive=this.users.length,this.played=0,this.movements=[];for(let u=0;u<t.length;u++)t[u].start(this,u)},p.prototype.acceptMove=function(s,t){this.played=this.played+1;for(let u of s)this.movements.push(Object.assign({position:t},u));this.played===this.alive&&(this.played=0,this.move())},p.prototype.move=function(){var s=this.movements.sort((u,v)=>v.remainingTime-u.remainingTime),t=f.Game.computeMovements(this.state,s);this.state=t.state,this.movements=[];for(let u of this.users)u.alive&&this.state.players[u.position].s===f.Player.statuses.dead&&(this.alive=this.alive-1,u.die()),u.sendActions(t.actions)},p.prototype.removeUser=function(s){if(s.alive){s.alive=!1,this.alive=this.alive-1,this.state.players[s.position].s=f.Player.statuses.dead;var t;for(let u of this.users)u.announceDeath(s.position),u.alive&&(t=u);if(1===this.alive)for(let u of this.users)u.announceWinner(t.position)}},q.prototype.start=function(s,t){this.game=s,this.started=!0,this.position=t,this.socket.emit('start',JSON.stringify(Object.assign(s.state,{position:t})))},q.prototype.die=function(){this.alive=!1},q.prototype.move=function(s){this.alive&&this.game.acceptMove(s,this.position)},q.prototype.announceDeath=function(){},q.prototype.announceWinner=function(s){this.socket.emit('winner',s)},q.prototype.startCount=function(){var s=this;this.timeout=setTimeout(function(){new p([s].concat(s.opponents)).start()},1000)},q.prototype.removeCount=function(){clearTimeout(this.timeout)},q.prototype.sendActions=function(s){this.socket.emit('actions',s)},module.exports=function(s){var t=new q(s);r.push(t),n(t),s.on('disconnect',function(){o(t)}),s.on('move',function(u){t.move(u)})}}()})();